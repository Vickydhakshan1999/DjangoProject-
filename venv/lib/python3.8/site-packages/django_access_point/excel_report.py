import openpyxl
from django.http import HttpResponse
from django.core.paginator import Paginator
from openpyxl import load_workbook
from django.db import transaction


class ExcelReportGenerator:
    """
    A base class to generate downloadable Excel reports from any given queryset.
    """

    def __init__(self, title, queryset, get_headers, get_row_data, chunk_size=100):
        self.title = title
        self.queryset = queryset
        self.chunk_size = chunk_size
        self.get_headers = get_headers
        self.get_row_data = get_row_data

    def generate_report(self):
        """
        Generate the Excel report and return it as an HTTP response.
        """
        # Create a workbook and a sheet
        wb = openpyxl.Workbook()
        ws = wb.active
        ws.title = self.title

        # Define headers based on model fields and custom fields
        headers = self.get_headers()

        # Write headers to the first row
        ws.append(headers)

        # Write data rows from the queryset
        self.write_data(ws)

        # Set the HTTP response for downloading the Excel file
        response = HttpResponse(
            content_type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )
        response["Content-Disposition"] = "attachment; filename=report.xlsx"

        # Save the workbook to the response object
        wb.save(response)

        return response

    def write_data(self, ws):
        """
        Write data to the Excel sheet in chunks to avoid memory overload.
        """
        paginator = Paginator(self.queryset, self.chunk_size)

        for page_number in paginator.page_range:
            page = paginator.page(page_number)

            for obj in page.object_list:
                row = self.get_row_data(obj)
                ws.append(row)





class ExcelDataImporter:
    """ 
    A base class to handle importing data from Excel files into the database.
    """

    def __init__(self, file, validate_headers, process_row):
        self.file = file
        self.validate_headers = validate_headers
        self.process_row = process_row

    def import_data(self):
        """
        Import data from the uploaded Excel file.
        """
        # Load the workbook
        wb = load_workbook(self.file)
        ws = wb.active

        # Validate headers
        headers = [cell.value for cell in ws[1]]
        if not self.validate_headers(headers):
            raise ValueError("Invalid headers in the Excel file.")

        # Process rows
        errors = []
        with transaction.atomic():  # Ensure atomicity
            for row in ws.iter_rows(min_row=2, values_only=True):
                try:
                    self.process_row(row)
                except Exception as e:
                    errors.append(f"Error processing row {row}: {str(e)}")

        return errors
